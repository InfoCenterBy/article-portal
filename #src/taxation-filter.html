<!DOCTYPE html>
<html lang="ru">
@@include('_head.html',{
"title":"Личный кабинет"
})

<body>
     <div class="wrapper">
          @@include('_header.html',{})
          <main class="page taxation-filter">
               <nav aria-label="breadcrumb">
                    <div class='container'>
                         <ol class="breadcrumb">
                              <li class="breadcrumb-item"><a href="main.html"><i class="bi bi-house"></i></a></li>
                              <li class="breadcrumb-item"><a href="main.html">Сервисы</a></li>
                              <li class="breadcrumb-item active" aria-current="page">Выбор режима налогообложения</li>
                         </ol>
                    </div>
               </nav>
               <section class="mb-5">
                    <div class='container'>

                         <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
                         <div class="sidebar-wrapper" id="app">
                              <div class="sidebar-wrapper__content access-content">
                                   <h1 class="h1 px-3">Выбор режима налогообложения</h1>

                                   <!-- <button @click="delel">del el</button> -->

                                   <div>
                                        <Transition name="filter-empty">
                                             <div class="w-100 filter-empty d-flex flex-column justify-content-center align-items-center"
                                                  v-if="isEmpty">
                                                  <p class="h5 text-center color-gray-dark">По выбранным условиям
                                                       нет
                                                       подходящего режима
                                                       налогообложения.
                                                       Попробуйте изменить условия выбора.
                                                  </p>
                                                  <img src="img/default-search.gif" alt="default-search">
                                             </div>
                                        </Transition>

                                        <transition-group tag="div" class="row w-100 card-scope " name="card-filter">
                                             <div v-for="item in filterList" :key="item.id"
                                                  class="col-md-4 card-filter my-2">
                                                  <div
                                                       class="card-wrapper d-flex flex-column my-2 justify-content-between p-4 h-100">
                                                       <h4 class="h4">{{item.title}}</h4>
                                                       <p>
                                                            {{item.body}}
                                                       </p>
                                                       <div class="mt-auto py-3 card-wrapper__more"
                                                            data-bs-toggle="modal"
                                                            :data-bs-target="'#' + 'modal' + '-'  + item.id">
                                                            Подробнее
                                                       </div>
                                                  </div>


                                             </div>
                                        </transition-group>
                                   </div>




                                   <div v-for="item in filterList" :key="item.id">
                                        <div class="modal fade" :id="'modal' + '-'  + item.id" tabindex="-1"
                                             aria-labelledby="exampleModalLabel" aria-hidden="true">
                                             <div class="modal-dialog modal-dialog-centered">
                                                  <div class="modal-content">
                                                       <div class="modal-header align-items-start">
                                                            <h5 class="modal-title" id="exampleModalLabel">
                                                                 {{item.title}}</h5>
                                                            <button type="button" class="btn-close"
                                                                 data-bs-dismiss="modal" aria-label="Close"></button>
                                                       </div>
                                                       <div class="modal-body">
                                                            {{item.body}}
                                                       </div>
                                                       <!-- <div class="modal-footer">
                                                       <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Close</button>
                                                       <button type="button" class="btn btn-primary">Save
                                                            changes</button>
                                                  </div> -->
                                                  </div>
                                             </div>
                                        </div>
                                   </div>




                              </div>
                              <aside data-da=".sidebar-wrapper__content,1100,1" class="sidebar-wrapper__aside mb-4">
                                   <h4 class="h4 h4_gold">Фильтры</h4>

                                   <form class="filter-form">

                                        <div class="d-flex flex-column">
                                             <div class="form-filter-title mb-3">
                                                  Категория налогоплательщика
                                             </div>
                                             <div class="form-check d-flex flex-row align-items-start mb-3"
                                                  v-for="category in categories">
                                                  <input type="checkbox" :id="category"
                                                       @click="checkCategories = category; categoriesFlag(category)"
                                                       :checked="checkCategories === category" class="form-check-input">
                                                  <label v-bind:for="category"
                                                       class="form-check-label ms-3">{{category}}</label>
                                             </div>
                                        </div>
                                        <div class="d-flex flex-column mt-4">
                                             <div class="form-filter-title mb-3">
                                                  Особенности
                                             </div>
                                             <div class="form-check d-flex flex-row align-items-start mb-3"
                                                  v-for="special in features">
                                                  <input type="checkbox" :id="special"
                                                       @click="specialFlag(special, $event)" class="form-check-input">
                                                  <label v-bind:for="special"
                                                       class="form-check-label ms-3">{{special}}</label>
                                             </div>
                                        </div>
                                        <div class="d-flex flex-column mt-4">
                                             <div class="form-filter-title mb-3">
                                                  Размер дохода за год
                                             </div>
                                             <input type="text" class="js-range-slider-income" name="income" value="">
                                        </div>
                                        <div class="d-flex flex-column mt-4">
                                             <div class="form-filter-title mb-3">
                                                  Количество сотрудников
                                             </div>

                                             <input type="text" class="js-range-slider-staff" name="staff" value="">
                                        </div>
                                        <div class="d-flex justify-content-center align-items-center filter-reset mt-4"
                                             @click="resetForm()">
                                             Очистить фильтр
                                        </div>
                                   </form>

                              </aside>


                         </div>
                         <script type="application/javascript">


                              const vueApp = new Vue({
                                   el: '#app',
                                   components: {
                                   },
                                   data() {
                                        return {
                                             listItems: [],
                                             filterList: [],
                                             // show: true,
                                             income: '',
                                             staff: '',
                                             checkCategories: '',
                                             checkFeatures: '',
                                             filterRule: {
                                                  income: 0.05,
                                                  staff: 0,
                                                  category: '',
                                                  special: [],
                                             },
                                             categories: ['Юридическое лицо', 'Индивидуальный предприниматель', 'Физическое лицо'],
                                             features: ['Производство подакцизных товаров', 'Производство сельхозпродукции'],
                                             isEmpty: false,
                                        }
                                   },
                                   watch: {
                                        income(dataIn) {
                                             // let newArr = this.listItems.filter(el => {
                                             //      return el.income <= data
                                             // })
                                             // this.income = data
                                             // console.log('income', dataIn)
                                             this.filterRule.income = dataIn
                                             this.filterEl()

                                        },
                                        staff(dataSt) {
                                             // console.log("staff", dataSt)
                                             this.filterRule.staff = dataSt
                                             this.filterEl()
                                        },
                                        checkCategories(dataCheck) {
                                             // this.check = dataCheck
                                             this.filterRule.category = dataCheck
                                             // console.log('dataCheck', this.filterRule)
                                             this.filterEl()
                                        },
                                        checkFeatures(dataFeatures) {
                                             // this.check = dataCheck
                                             // if (this.filterRule.special.includes(dataFeatures)) {
                                             // console.log(dataFeatures)


                                             // this.filterRule.special.push({ title: dataFeatures, status: true })

                                             // if (!this.filterRule.special.includes(dataFeatures)) {
                                             //      this.filterRule.special.push(dataFeatures)
                                             //      // console.log("PUSHED")
                                             // }
                                             // else {
                                             //      let indexFeature = this.filterRule.special.indexOf(dataFeatures)
                                             //      if (indexFeature !== -1) {
                                             //           this.filterRule.special.splice(indexFeature, 1);
                                             //      }
                                             // }

                                             // }
                                             // console.log('RULES', this.filterRule)
                                             // console.log('dataspecial', this.filterRule.special.includes(dataFeatures))
                                        },

                                   },
                                   methods: {
                                        async getData() {
                                             try {
                                                  // const res = await fetch("https://jsonplaceholder.typicode.com/posts")
                                                  // const finalRes = await res.json()
                                                  // this.listItems = finalRes.slice(0, 8)
                                                  let dataFilter = [{
                                                       id: 1,
                                                       title: 'ОПН для ЮЛ',
                                                       body: 'Общий порядок налогообложения для юридических лиц',
                                                       category: 'Юридическое лицо',
                                                       features: ['Производство подакцизных товаров'],
                                                       income: 5,
                                                       staff: 60,
                                                  }, {
                                                       id: 2,
                                                       title: 'УСН для ЮЛ',
                                                       body: 'Упрощенная система налогообложения для юридических лиц',
                                                       category: 'Юридическое лицо',
                                                       features: [],
                                                       income: 2.15,
                                                       staff: 50,
                                                  },
                                                  {
                                                       id: 3,
                                                       title: 'Единый налог для производителей сельскохозяйственной продукции',
                                                       body: '',
                                                       category: 'Юридическое лицо',
                                                       features: ['Производство сельхозпродукции'],
                                                       income: 5,
                                                       staff: 60,
                                                  },
                                                  // {
                                                  //      id: 4,
                                                  //      title: 'Налог на игорный бизнес',
                                                  //      body: '',
                                                  //      category: 'Юридическое лицо',
                                                  //      features: ['Игорный бизнес'],
                                                  //      income: 0,
                                                  //      staff: 0,
                                                  // },
                                                  {
                                                       id: 5,
                                                       title: 'ОПН для ИП',
                                                       body: 'Общий порядок налогообложения для индивидуальных предпринимателей',
                                                       category: 'Индивидуальный предприниматель',
                                                       features: ['Производство подакцизных товаров'],
                                                       income: 5,
                                                       staff: 3,
                                                  },
                                                  {
                                                       id: 6,
                                                       title: 'Единый налог с ИП и иных ФЛ (для ИП)',
                                                       body: 'Единый налог с индивидуальных предпринимателей и иных физических лиц (для индивидуальных предпринимателей)',
                                                       category: 'Индивидуальный предприниматель',
                                                       features: [],
                                                       income: 5,
                                                       staff: 3,
                                                  }
                                                       ,
                                                  {
                                                       id: 7,
                                                       title: 'Единый налог с ИП и иных ФЛ (для ФЛ)',
                                                       body: 'Единый налог с индивидуальных предпринимателей и иных физических лиц (для физических лиц)',
                                                       category: 'Физическое лицо',
                                                       features: [],
                                                       income: 5,
                                                       staff: 0,
                                                  },
                                                  {
                                                       id: 8,
                                                       title: 'НПД',
                                                       body: 'Налог на профессиональный доход',
                                                       category: 'Физическое лицо',
                                                       features: [],
                                                       income: 5,
                                                       staff: 0,
                                                  },]
                                                  this.listItems = dataFilter
                                                  this.filterList = this.listItems
                                             }
                                             catch (error) {
                                                  console.log(error)
                                             }
                                        },
                                        initSlider() {

                                             $(".js-range-slider-income").ionRangeSlider({
                                                  skin: 'round',
                                                  type: "double",
                                                  from: 0,
                                                  from_fixed: true,
                                                  to: 0,
                                                  min: 0,
                                                  max: 5,
                                                  grid: true,
                                                  grid_num: 5,
                                                  postfix: ' млн',
                                                  step: 0.05,
                                                  max_postfix: '+ ',
                                                  force_edges: true,
                                                  onChange: function () {
                                                       document.querySelectorAll('.js-irs-0 .irs-from').forEach(el => {
                                                            el.innerHTML = '0'
                                                       })
                                                  },
                                             });

                                             $(".js-range-slider-staff").ionRangeSlider({
                                                  skin: "round",
                                                  type: "double",
                                                  from: 0,
                                                  from_fixed: true,
                                                  to: 0,
                                                  min: 0,
                                                  max: 60,
                                                  grid: true,
                                                  grid_num: 6,
                                                  step: 1,
                                                  max_postfix: '+ ',
                                                  force_edges: true,
                                             });



                                        },
                                        modifyEl() {
                                             try {
                                                  document.querySelectorAll(".js-irs-0 .irs-grid-text").forEach(el => {
                                                       if (el.innerHTML != '0' && el.innerHTML != '5') {
                                                            el.innerHTML = el.innerHTML + ' млн'
                                                       }
                                                       if (el.innerHTML == '5') {
                                                            el.innerHTML = ' '
                                                       }
                                                  })
                                                  document.querySelectorAll('.js-irs-0 .irs-from').forEach(el => {
                                                       el.innerHTML = '0'
                                                  })
                                             }
                                             catch (error) {
                                                  console.log(error)
                                             }

                                             try {
                                                  document.querySelectorAll(".js-irs-1 .irs-grid-text").forEach(el => {
                                                       if (el.innerHTML == '500') {
                                                            el.innerHTML = ' '
                                                       }
                                                  })
                                             }
                                             catch (error) {
                                                  console.log(error)
                                             }

                                             try {


                                                  document.querySelectorAll('.js-irs-0 .irs-to').forEach(el => {
                                                       el.addEventListener('DOMSubtreeModified', (e) => {
                                                            // add " * 1000000 " in the end of next line if data if millions (now in short form - 1.2)
                                                            this.income = Math.fround($('.js-range-slider-income').prop("value").replace(/0;/g, '')).toFixed(2)
                                                       })
                                                  })

                                                  document.querySelectorAll('.js-irs-1 .irs-to').forEach(el => {
                                                       el.addEventListener('DOMSubtreeModified', (e) => {
                                                            this.staff = parseInt($('.js-range-slider-staff').prop("value").replace(/0;/g, ''))
                                                       })
                                                  })
                                             }
                                             catch (error) {
                                                  console.log(error)
                                             }
                                        },
                                        filterEl() {

                                             try {
                                                  this.isEmpty = false

                                                  let sortedFilter = this.filterRule.special.sort()
                                                  // console.log('sortedFilter', sortedFilter)
                                                  const newList = this.listItems.filter(el => {
                                                       let sortedItems = el.features.slice().sort()
                                                       // console.log('sortedItems', sortedItems)

                                                       if (this.filterRule.category === '' && this.filterRule.special.length == 0) {
                                                            return el.income >= this.filterRule.income
                                                                 && el.staff >= this.filterRule.staff

                                                       } else
                                                            if (this.filterRule.category !== '' && this.filterRule.special.length !== 0) {

                                                                 return el.income >= this.filterRule.income
                                                                      && el.staff >= this.filterRule.staff
                                                                      && el.category === this.filterRule.category
                                                                      && this.filterRule.special.some(fit => el.features.includes(fit))
                                                                 // && JSON.stringify(sortedFilter) === JSON.stringify(sortedItems)

                                                            }
                                                            else if (this.filterRule.category === '' && this.filterRule.special.length !== 0) {
                                                                 return el.income >= this.filterRule.income
                                                                      && el.staff >= this.filterRule.staff
                                                                      && this.filterRule.special.some(fit => el.features.includes(fit))
                                                                 // && JSON.stringify(sortedFilter) === JSON.stringify(sortedItems)
                                                            }
                                                            else {
                                                                 return el.income >= this.filterRule.income
                                                                      && el.staff >= this.filterRule.staff
                                                                      && el.category === this.filterRule.category
                                                            }
                                                  })

                                                  // const newList = this.listItems.filter(el => {
                                                  //      return this.filterRule.special.some((f) => {
                                                  //           return f === el.features
                                                  //      })
                                                  // })

                                                  // const newList = this.listItems.filter(obj => {
                                                  //      return obj.income <= this.filterRule.income &&
                                                  //           obj.staff <= this.filterRule.staff &&
                                                  //           obj.category === this.filterRule.category &&
                                                  //           obj.features.some(f => this.filterRule.special.includes(f));
                                                  // });


                                                  this.filterList = newList
                                                  if (newList.length === 0) {
                                                       this.isEmpty = true
                                                  }

                                             }

                                             catch (error) {
                                                  console.log(error)
                                             }


                                        },

                                        categoriesFlag(category) {
                                             if (this.filterRule.category == category) {
                                                  this.filterRule.category = ''
                                                  this.checkCategories = ''
                                                  this.filterEl()
                                             }

                                        },

                                        specialFlag(special, event) {

                                             if (event.target.checked) {
                                                  console.log('isSelected' + special);
                                                  this.filterRule.special.push(special)


                                             } else
                                                  if (!event.target.checked) {
                                                       console.log('Unselecded' + special);
                                                       let indexFeature = this.filterRule.special.indexOf(special)
                                                       if (indexFeature !== -1) {
                                                            this.filterRule.special.splice(indexFeature, 1);
                                                       }
                                                  }

                                             this.filterEl()
                                        },
                                        resetForm() {
                                             // this.filterRule.income = 5
                                             // this.filterRule.staff = 500
                                             // this.filterRule.category = ''
                                             // this.filterRule.special = []
                                             // this.checkCategories = ''
                                             // this.checkFeatures = ''
                                             // document.querySelectorAll('.irs-bar').forEach(el => {
                                             //      el.style.width = '95.5%'
                                             // })
                                             // document.querySelectorAll('.irs-handle.to').forEach(el => {
                                             //      el.style.left = "92.5%"
                                             // })
                                             // document.querySelectorAll('.irs-to').forEach(el => {
                                             //      el.style.left = "90%"
                                             // })

                                             // this.initSlider()
                                             // document.querySelector('.filter-form').reset()
                                             location.reload()
                                             // this.filterEl()
                                        }
                                   },
                                   mounted() {
                                        this.getData()
                                        this.initSlider()
                                        this.modifyEl()
                                   }
                              })
                         </script>
                    </div>
               </section>
          </main>
          @@include('_footer.html',{})
     </div>
     @@include('_js.html',{})
</body>

</html>