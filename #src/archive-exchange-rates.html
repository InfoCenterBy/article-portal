<!DOCTYPE html>
<html lang="ru">
@@include('_head.html',{
"title":"Архив курсов валют"
})

<body>
  @@include('./new-main/main-components/_new-header.html')
  @@include('./new-main/main-components/_search-modal.html')
  @@include('./new-main/main-components/_nav.html')

  <div class="nav-container active-container">

    <!-- Nav Button -->
    <a class="" id="menu-btn"><i class="bi bi-chevron-right"></i></a>
    <!--Nav Button -->
    <div class="main-content">
      <section class="main-section">
        <div class="row">
          <nav aria-label="breadcrumb" class="col-12">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="main.html"><i class="bi bi-house"></i></a></li>
              <li class="breadcrumb-item"><a href="#">Справочная информация</a></li>
              <li class="breadcrumb-item " aria-current="page">Архив курсов валют</li>
            </ol>
          </nav>
        </div>
      </section>
      <div class="mt-4"></div>
      <div class="main-section">
        <div class="">
          <strong class="ff-inter fs-28">
            Архив курсов валют
          </strong>
        </div>
        <div class="row mt-4">
          <div class="col-12 col-lg-6">
            <div class="border-20 border-1-5-gray p-3 p-lg-4">
              <p class="fs-24 fw-semibold">
                Курсы валют на
                <span class="color-gold date-display">07.02.2025</span>
                <span class="date-container">
                  <label class="cur-label cursor-pointer" for="cur-date-small"><i class="bi bi-calendar4-event color-gold cursor-pointer fs-20"></i>
                  </label>
                  <input class="opacity-0 cur-date" id="cur-date-small" type="date" name="cur-date">
                </span>
              </p>
              <div class="table-default">
                <table class="w-100">
                  <thead>
                    <tr>
                      <td>
                        Наименование иностранной валюты
                      </td>
                      <td>
                        Количество единиц иностранной валюты, буквенный код валюты
                      </td>
                      <td>
                        Официальный курс, (BYN)
                      </td>
                    </tr>
                  </thead>
                  <tbody class="list-exchange-rates list-exchange-rates--small">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="border-20 border-1-5-gray p-3 p-lg-4">
              <p class="fs-24 fw-semibold">
                Курсы валют на
                <span class="color-gold" id="date-display">07.02.2025</span>
                <span class="date-container">
                  <label class="cursor-pointer" for="cur-date" id="cur-label"> <i class="bi bi-calendar4-event color-gold cursor-pointer fs-20"></i></label>
                  <input class="opacity-0" id="cur-date" type="date" name="cur-date">
                </span>
              </p>
            </div>
            <canvas id="chart-rates"></canvas>
          </div>


        </div>
        <div class="mt-5">
          <p class="fs-24 fw-semibold">
            Курсы валют на
            <span class="color-gold date-display">07.02.2025</span>
            <span class="date-container">
              <label class="cur-label cursor-pointer" for="cur-date-large"><i class="bi bi-calendar4-event color-gold cursor-pointer fs-20"></i>
              </label>
              <input class="opacity-0 cur-date" id="cur-date-large" type="date" name="cur-date">
            </span>
          </p>
          <div class="table-default">
            <table class="w-100">
              <thead>
                <tr>
                  <td>
                    Наименование иностранной валюты
                  </td>
                  <td>
                    Количество единиц иностранной валюты, буквенный код валюты
                  </td>
                  <td>
                    Официальный курс, (BYN)
                  </td>
                </tr>
              </thead>
              <tbody class="list-exchange-rates list-exchange-rates--large">
              </tbody>
            </table>
          </div>
        </div>

      </div>
      <div class="my-5"></div>
      @@include('./new-main/main-components/_new-footer.html')
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dateInputs = document.querySelectorAll('.cur-date');
        const dateDisplay = document.querySelectorAll('.date-display');
        const calendarIcons = document.querySelectorAll('.cur-label');

        const today = new Date();
        const formattedToday = formatDateToInput(today);

        dateInputs.forEach(input => {
          input.value = formattedToday;
        })

        updateDisplayedDate(formattedToday);

        getRateForCurrency(formattedToday);

        dateInputs.forEach(input => {
          input.addEventListener('change', function () {
            updateDisplayedDate(this.value);
            getRateForCurrency(this.value);
          });
        })


        function updateDisplayedDate(dateString) {
          const date = new Date(dateString);
          const formattedDate = formatDateToDisplay(date);
          dateDisplay.forEach(date => {
            date.textContent = formattedDate;
          })
        }

        function formatDateToDisplay(date) {
          const day = date.getDate().toString().padStart(2, '0');
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const year = date.getFullYear();
          return `${day}.${month}.${year}`;
        }

        function formatDateToInput(date) {
          const year = date.getFullYear();
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          return `${year}-${month}-${day}`;
        }

        const listExchangeRatesLarge = document.querySelector(".list-exchange-rates--large");
        const listExchangeRatesSmall = document.querySelector(".list-exchange-rates--small");

        const createListExchangeRates = (exchangeRatesList) => {
          listExchangeRatesLarge.innerHTML = ""
          exchangeRatesList.forEach(item => {
            listExchangeRatesLarge.innerHTML += `<tr>
                                                <td>
                                                  <div class="d-flex align-items-center">
                                                    <img src="./img/countries-flags/${item.Cur_Abbreviation}.svg" alt="flag">
                                                    <span>${item.Cur_Name}</span>
                                                  </div>
                                                </td>
                                                <td>
                                                  ${item.Cur_Scale} ${item.Cur_Abbreviation}
                                                </td>
                                                <td>
                                                   ${item.Cur_OfficialRate}
                                                </td>
                                            </tr>
                                          `;
          })
          const commonRatesList = ["USD", "EUR", "RUB", "CNY", "KZT", "PLN"];
          let commonRates = exchangeRatesList.filter(rate => commonRatesList.includes(rate.Cur_Abbreviation))
          console.log(commonRates);

          listExchangeRatesSmall.innerHTML = ""
          commonRates.forEach(item => {
            listExchangeRatesSmall.innerHTML += `<tr>
                                                <td>
                                                  <div class="d-flex align-items-center">
                                                    <img src="./img/countries-flags/${item.Cur_Abbreviation}.svg" alt="flag">
                                                    <span>${item.Cur_Name}</span>
                                                  </div>
                                                </td>
                                                <td>
                                                  ${item.Cur_Scale} ${item.Cur_Abbreviation}
                                                </td>
                                                <td>
                                                   ${item.Cur_OfficialRate}
                                                </td>
                                            </tr>
                                          `;
          })


        };

        async function getRateForCurrency(date) {
          try {
            const response = await fetch(`https://api.nbrb.by/exrates/rates?ondate=${date}&periodicity=0`);
            const data = await response.json();
            createListExchangeRates(data);
            return data
          } catch (error) {
            console.error('Ошибка при получении курса:', error);
          }
        }

        calendarIcons.forEach(icon => {
          icon.addEventListener('click', function () {
            const inputId = this.getAttribute('for');
            const dateInput = document.getElementById(inputId);
            dateInput.showPicker();
          });
        })

        async function getWeeklyRates(currencyId, currencyCode) {
          try {
            // Получаем даты начала и конца текущей недели
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(now);
            endOfWeek.setHours(23, 59, 59, 999);

            // Форматируем даты
            const formatDate = (date) => date.toISOString().split('T')[0];

            const startDateStr = formatDate(startOfWeek);
            const endDateStr = formatDate(endOfWeek);

            // Проверяем кэш (если нужно)
            const cacheKey = `rates_${currencyId}_${startDateStr}`;
            const cachedData = localStorage.getItem(cacheKey);

            if (cachedData) {
              const parsedData = JSON.parse(cachedData);
              if (new Date(parsedData.expiry) > new Date()) {
                return parsedData.rates;
              }
            }

            // Делаем запрос к API
            const response = await fetch(`https://www.nbrb.by/API/ExRates/Rates/Dynamics/${currencyId}?startDate=${startDateStr}&endDate=${endDateStr}`);

            if (!response.ok) {
              throw new Error(`Ошибка HTTP: ${response.status}`);
            }

            const ratesData = await response.json();

            // Обрабатываем данные
            const weeklyRates = ratesData.map(item => ({
              date: new Date(item.Date).toLocaleDateString('ru-RU'),
              dateObj: new Date(item.Date),
              rate: item.Cur_OfficialRate,
              scale: item.Cur_Scale,
              currency: currencyCode
            }));

            // Сохраняем в кэш на 1 час
            const cacheData = {
              rates: weeklyRates,
              expiry: new Date().getTime() + 60 * 60 * 1000 // 1 час
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheData));

            return weeklyRates;

          } catch (error) {
            console.error(`Ошибка при получении курса ${currencyCode}:`, error);
            throw new Error(`Не удалось получить курс ${currencyCode} на неделю`);
          }
        }
        // [431 - usd, 456 - rub, 452 - pln, 462 - cny, 459 - kzt, 451 - eur]
        // Пример использования для разных валют:
        async function getAllWeeklyRates() {
          const currencies = [
            { id: 431, code: 'USD', name: 'Доллар США' },
            { id: 451, code: 'EUR', name: 'Евро' },
            { id: 456, code: 'RUB', name: 'Российских рублей' },
            { id: 452, code: 'PLN', name: 'Злотых' },
            { id: 462, code: 'CNY', name: 'Китайских юаней' },
            { id: 459, code: 'KZT', name: 'Тенге' },
          ];

          try {
            const allRates = await Promise.all(
              currencies.map(async currency => ({
                currency: currency.name,
                rates: await getWeeklyRates(currency.id, currency.code)
              }))
            );

            console.log('Все курсы на неделю:', allRates);
            return allRates;

          } catch (error) {
            console.error('Ошибка при получении всех курсов:', error);
          }
        }
        getAllWeeklyRates()
      });
    </script>

    @@include('_js.html',{})
    [431-usd, 456-rub, 452-pln, 462-cny, 459-kzt, 451-eur]

    <script>
      const ctx = document.getElementById('chart-rates');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
          datasets: [{
            label: '# of Votes',
            data: [12, 19, 3, 5, 2, 3],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    </script>
</body>

</html>