<!DOCTYPE html>
<html lang="ru">
@@include('_head.html',{
"title":"Архив курсов валют"
})

<body>
  @@include('./new-main/main-components/_new-header.html')
  @@include('./new-main/main-components/_search-modal.html')
  @@include('./new-main/main-components/_nav.html')

  <div class="nav-container active-container">

    <!-- Nav Button -->
    <a class="" id="menu-btn"><i class="bi bi-chevron-right"></i></a>
    <!--Nav Button -->
    <div class="main-content">
      <section class="main-section">
        <div class="row">
          <nav aria-label="breadcrumb" class="col-12">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="main.html"><i class="bi bi-house"></i></a></li>
              <li class="breadcrumb-item"><a href="#">Справочная информация</a></li>
              <li class="breadcrumb-item " aria-current="page">Архив курсов валют</li>
            </ol>
          </nav>
        </div>
      </section>
      <div class="mt-4"></div>
      <div class="main-section">
        <div class="">
          <strong class="ff-inter fs-28">
            Архив курсов валют
          </strong>
        </div>
        <div class="row mt-4">
          <div class="col-12 col-lg-6">
            <div class="border-20 border-1-5-gray p-3 p-lg-4">
              <p class="fs-24 fw-semibold">
                Курсы валют на
                <span class="color-gold date-display">07.02.2025</span>
                <span class="date-container">
                  <label class="cur-label cursor-pointer" for="cur-date-small"><i class="bi bi-calendar4-event color-gold cursor-pointer fs-20"></i>
                  </label>
                  <input class="opacity-0 cur-date" id="cur-date-small" type="date" name="cur-date">
                </span>
              </p>
              <div class="table-default">
                <table class="w-100">
                  <thead>
                    <tr>
                      <td>
                        Наименование иностранной валюты
                      </td>
                      <td>
                        Количество единиц иностранной валюты, буквенный код валюты
                      </td>
                      <td>
                        Официальный курс, (BYN)
                      </td>
                    </tr>
                  </thead>
                  <tbody class="list-exchange-rates list-exchange-rates--small">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6 d-flex">
            <div class="border-20 border-1-5-gray p-3 p-lg-4 w-100 mt-4 mt-lg-0">
              <p class="fs-24 fw-semibold">
                График архива курсов валют
              </p>
              <div class="chart-container">
                <canvas id="currencyChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-5">
          <p class="fs-24 fw-semibold">
            Курсы валют на
            <span class="color-gold date-display">07.02.2025</span>
            <span class="date-container">
              <label class="cur-label cursor-pointer" for="cur-date-large"><i class="bi bi-calendar4-event color-gold cursor-pointer fs-20"></i>
              </label>
              <input class="opacity-0 cur-date" id="cur-date-large" type="date" name="cur-date">
            </span>
          </p>
          <div class="table-default">
            <table class="w-100">
              <thead>
                <tr>
                  <td>
                    Наименование иностранной валюты
                  </td>
                  <td>
                    Количество единиц иностранной валюты, буквенный код валюты
                  </td>
                  <td>
                    Официальный курс, (BYN)
                  </td>
                </tr>
              </thead>
              <tbody class="list-exchange-rates list-exchange-rates--large">
              </tbody>
            </table>
          </div>
        </div>

      </div>
      <div class="my-5"></div>
      @@include('./new-main/main-components/_new-footer.html')
    </div>
    @@include('_js.html',{})

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dateInputs = document.querySelectorAll('.cur-date');
        const dateDisplay = document.querySelectorAll('.date-display');
        const calendarIcons = document.querySelectorAll('.cur-label');

        const today = new Date();
        const formattedToday = formatDateToInput(today);

        dateInputs.forEach(input => {
          input.value = formattedToday;
        })

        updateDisplayedDate(formattedToday);

        getRateForCurrency(formattedToday);

        dateInputs.forEach(input => {
          input.addEventListener('change', function () {
            updateDisplayedDate(this.value);
            getRateForCurrency(this.value);
          });
        })


        function updateDisplayedDate(dateString) {
          const date = new Date(dateString);
          const formattedDate = formatDateToDisplay(date);
          dateDisplay.forEach(date => {
            date.textContent = formattedDate;
          })
        }

        function formatDateToDisplay(date) {
          const day = date.getDate().toString().padStart(2, '0');
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const year = date.getFullYear();
          return `${day}.${month}.${year}`;
        }

        function formatDateToInput(date) {
          const year = date.getFullYear();
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          return `${year}-${month}-${day}`;
        }

        const listExchangeRatesLarge = document.querySelector(".list-exchange-rates--large");
        const listExchangeRatesSmall = document.querySelector(".list-exchange-rates--small");

        const createListExchangeRates = (exchangeRatesList) => {
          listExchangeRatesLarge.innerHTML = ""
          exchangeRatesList.forEach(item => {
            listExchangeRatesLarge.innerHTML += `<tr>
                                                <td>
                                                  <div class="d-flex align-items-center">
                                                    <img src="./img/countries-flags/${item.Cur_Abbreviation}.svg" alt="flag">
                                                    <span>${item.Cur_Name}</span>
                                                  </div>
                                                </td>
                                                <td>
                                                  ${item.Cur_Scale} ${item.Cur_Abbreviation}
                                                </td>
                                                <td>
                                                   ${item.Cur_OfficialRate}
                                                </td>
                                            </tr>
                                          `;
          })
          const commonRatesList = ["USD", "EUR", "RUB", "CNY", "KZT", "PLN"];
          let commonRates = exchangeRatesList.filter(rate => commonRatesList.includes(rate.Cur_Abbreviation))
          console.log(commonRates);

          listExchangeRatesSmall.innerHTML = ""
          commonRates.forEach(item => {
            listExchangeRatesSmall.innerHTML += `<tr>
                                                <td>
                                                  <div class="d-flex align-items-center">
                                                    <img src="./img/countries-flags/${item.Cur_Abbreviation}.svg" alt="flag">
                                                    <span>${item.Cur_Name}</span>
                                                  </div>
                                                </td>
                                                <td>
                                                  ${item.Cur_Scale} ${item.Cur_Abbreviation}
                                                </td>
                                                <td>
                                                   ${item.Cur_OfficialRate}
                                                </td>
                                            </tr>
                                          `;
          })


        };

        async function getRateForCurrency(date) {
          try {
            const response = await fetch(`https://api.nbrb.by/exrates/rates?ondate=${date}&periodicity=0`);
            const data = await response.json();
            createListExchangeRates(data);
            return data
          } catch (error) {
            console.error('Ошибка при получении курса:', error);
          }
        }

        calendarIcons.forEach(icon => {
          icon.addEventListener('click', function () {
            const inputId = this.getAttribute('for');
            const dateInput = document.getElementById(inputId);
            dateInput.showPicker();
          });
        })

        async function getRates(currencyID, period = 'week', customDate = null) {
          try {
            let startDate, endDate;

            // Определяем период на основе аргумента
            switch (period) {
              case 'week':
                ({ startDate, endDate } = getCurrentWeek());
                break;
              case 'month':
                ({ startDate, endDate } = getCurrentMonth());
                break;
              case 'custom':
                if (!customDate) {
                  throw new Error('Для custom периода необходимо указать дату');
                }
                ({ startDate, endDate } = getCustomMonth(customDate));
                break;
              case 'year':
                ({ startDate, endDate } = getLastYear());
                break;
              default:
                throw new Error('Неверный период. Доступные значения: week, month, custom, year');
            }

            // Форматируем даты для API
            const formatDate = (date) => {
              const year = date.getFullYear();
              const month = (date.getMonth() + 1).toString().padStart(2, '0');
              const day = date.getDate().toString().padStart(2, '0');
              return `${year}-${month}-${day}`;
            };

            const startDateStr = formatDate(startDate);
            const endDateStr = formatDate(endDate);

            console.log(`Запрос данных за период: ${startDateStr} - ${endDateStr}`);

            // Делаем запрос к API
            const response = await fetch(`https://www.nbrb.by/API/ExRates/Rates/Dynamics/${currencyID}?startDate=${startDateStr}&endDate=${endDateStr}`);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const rates = await response.json();

            // Обрабатываем полученные данные
            const processedRates = rates.map(rate => ({
              date: new Date(rate.Date).toLocaleDateString('ru-RU'),
              rate: rate.Cur_OfficialRate,
              scale: rate.Cur_Scale,
              dateObj: new Date(rate.Date)
            }));

            // Сортируем по дате (от старых к новым)
            processedRates.sort((a, b) => a.dateObj - b.dateObj);

            return processedRates;

          } catch (error) {
            console.error('Ошибка при получении курсов:', error);
            throw error;
          }
        }

        // Вспомогательные функции для расчета периодов

        function getCurrentWeek() {
          const now = new Date();
          const dayOfWeek = now.getDay();

          const startOfWeek = new Date(now);
          if (dayOfWeek === 0) {
            startOfWeek.setDate(now.getDate() - 6);
          } else {
            startOfWeek.setDate(now.getDate() - dayOfWeek + 1);
          }
          startOfWeek.setHours(0, 0, 0, 0);

          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6);
          endOfWeek.setHours(23, 59, 59, 999);

          return { startDate: startOfWeek, endDate: endOfWeek };
        }

        function getCurrentMonth() {
          const now = new Date();

          const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
          startOfMonth.setHours(0, 0, 0, 0);

          const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          endOfMonth.setHours(23, 59, 59, 999);

          return { startDate: startOfMonth, endDate: endOfMonth };
        }

        function getCustomMonth(date) {
          const inputDate = new Date(date);

          const startOfMonth = new Date(inputDate.getFullYear(), inputDate.getMonth(), 1);
          startOfMonth.setHours(0, 0, 0, 0);

          const endOfMonth = new Date(inputDate.getFullYear(), inputDate.getMonth() + 1, 0);
          endOfMonth.setHours(23, 59, 59, 999);

          return { startDate: startOfMonth, endDate: endOfMonth };
        }

        function getLastYear() {
          const now = new Date();

          const startOfYear = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
          startOfYear.setHours(0, 0, 0, 0);

          const endOfYear = new Date(now);
          endOfYear.setHours(23, 59, 59, 999);

          return { startDate: startOfYear, endDate: endOfYear };
        }
        // [431 - usd, 456 - rub, 452 - pln, 462 - cny, 459 - kzt, 451 - eur]
        // Пример использования для разных валют:
        let data = null
        const currencies = [
          { id: 431, code: 'USD', name: '1 Доллар США' },
          { id: 451, code: 'EUR', name: '1 Евро' },
          { id: 456, code: 'RUB', name: '100 Российских рублей' },
          { id: 452, code: 'PLN', name: '10 Злотых' },
          { id: 462, code: 'CNY', name: '10 Китайских юаней' },
          { id: 459, code: 'KZT', name: '1000 Тенге' },
        ];

        // async function getAllWeeklyRates() {
        //   try {
        //     const allRates = await Promise.all(
        //       currencies.map(async currency => ({
        //         currency: currency.name,
        //         rates: await getRates(currency.id)
        //       }))
        //     );

        //     console.log('Все курсы на неделю:', allRates);
        //     let data = allRates
        //     const dates = [...new Set(data.flatMap(c => c.rates.map(r => r.date)))].sort();

        //     new Chart(document.getElementById('currencyChart').getContext('2d'), {
        //       type: 'line',
        //       data: {
        //         labels: dates,
        //         datasets: data.map((c, i) => ({
        //           label: c.currency,
        //           data: dates.map(d => c.rates.find(r => r.date === d)?.rate || null),
        //           borderColor: `hsl(${i * 60}, 70%, 50%)`,
        //           tension: 0.3
        //         }))
        //       }
        //     });
        //     return allRates;

        //   } catch (error) {
        //     console.error('Ошибка при получении всех курсов:', error);
        //   }
        // }
        // getAllWeeklyRates()

        async function getAllMonthlyRates() {
          try {
            const allRates = await Promise.all(
              currencies.map(async currency => ({
                currency: currency.name,
                rates: await getRates(currency.id, 'month')
              }))
            );

            console.log('Все курсы на месяц:', allRates);
            let data = allRates
            const dates = [...new Set(data.flatMap(c => c.rates.map(r => r.date)))].sort();

            new Chart(document.getElementById('currencyChart').getContext('2d'), {
              type: 'line',
              data: {
                labels: dates,
                datasets: data.map((c, i) => ({
                  label: c.currency,
                  data: dates.map(d => c.rates.find(r => r.date === d)?.rate || null),
                }))
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    ticks: {
                      minTicksLimit: 15,
                      stepSize: 0.01,
                      callback: function (value) {
                        return value.toFixed(3);
                      },
                      grace: '50%'
                    },
                    beginAtZero: false
                  }
                },

              },
              plugins: {
                legend: {
                  labels: {
                    usePointStyle: true, // используем стиль точек вместо прямоугольников
                    pointStyle: 'image', // указываем что хотим использовать изображения
                    generateLabels: function (chart) {
                      const original = Chart.overrides.line.plugins.legend.labels.generateLabels;
                      const labelsOriginal = original.call(this, chart);

                      // Маппинг валют на изображения
                      const currencyImages = {
                        'USD': './img/countries-flags/USD.svg',
                        'EUR': 'https://example.com/eur-flag.png',
                        'PLN': 'https://example.com/pln-flag.png',
                        'CNY': 'https://example.com/cny-flag.png',
                        'RUB': 'https://example.com/rub-flag.png',
                        'KZT': 'https://example.com/kzt-flag.png'
                      };

                      // Добавляем изображения к лейблам
                      labelsOriginal.forEach(label => {
                        const currencyCode = label.text.split(' - ')[0];
                        label.pointStyle = new Image();
                        label.pointStyle.src = currencyImages[currencyCode];
                        label.pointStyle.width = 20;
                        label.pointStyle.height = 15;
                      });

                      return labelsOriginal;
                    }
                  }
                }
              }

            });
            return allRates;

          } catch (error) {
            console.error('Ошибка при получении всех курсов:', error);
          }
        }
        getAllMonthlyRates()



      });
    </script>
</body>

</html>